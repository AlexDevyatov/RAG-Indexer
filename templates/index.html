<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Indexer - –ü–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1.5rem 0;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .card-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Progress Bar */
        .progress-container {
            background: var(--bg-input);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-title {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border);
            transform: translateY(-50%);
            z-index: 0;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
            background: var(--bg-input);
            padding: 0 0.5rem;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            transition: all 0.3s;
        }
        
        .step-icon.pending {
            border-color: var(--border);
            color: var(--text-muted);
        }
        
        .step-icon.processing {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .step-icon.completed {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .step-icon.error {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        .step-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: center;
            max-width: 70px;
        }
        
        .step-status {
            font-size: 1rem;
        }
        
        .progress-message {
            margin-top: 0.75rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            min-height: 1.2em;
        }
        
        .progress-message.error {
            color: var(--danger);
        }
        
        /* Percentage Progress Bar */
        .percent-bar-container {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .percent-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .percent-bar-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .percent-bar-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .percent-bar {
            height: 12px;
            background: var(--bg-card);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .percent-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #a855f7);
            border-radius: 6px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .percent-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,255,255,0.2) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .percent-bar-fill.complete {
            background: var(--success);
        }
        
        .percent-bar-fill.complete::after {
            animation: none;
        }
        
        /* Drop Zone */
        .dropzone {
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-input);
        }
        
        .dropzone:hover, .dropzone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .dropzone-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .dropzone-text {
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .dropzone-formats {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        #fileInput {
            display: none;
        }
        
        /* File List */
        .file-list {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--bg-input);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .file-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .file-status {
            font-size: 0.875rem;
        }
        
        .file-status.success { color: var(--success); }
        .file-status.error { color: var(--danger); }
        .file-status.pending { color: var(--text-muted); }
        
        /* Search */
        .search-form {
            display: flex;
            gap: 0.75rem;
        }
        
        .search-input {
            flex: 1;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-input);
            color: var(--text);
            font-size: 1rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Results */
        .results {
            margin-top: 1.5rem;
        }
        
        .answer-box {
            background: var(--bg-input);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }
        
        .answer-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .answer-text {
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .sources {
            margin-top: 1rem;
        }
        
        .sources-title {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .source-item {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Loading */
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        
        /* Actions */
        .actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç RAG Indexer</h1>
            <p class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã</p>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="statVectors">0</div>
                    <div class="stat-label">–í–µ–∫—Ç–æ—Ä–æ–≤</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statDocs">0</div>
                    <div class="stat-label">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statChunks">0</div>
                    <div class="stat-label">–ß–∞–Ω–∫–æ–≤</div>
                </div>
            </div>
        </header>
        
        <div class="grid">
            <!-- Upload Section -->
            <div class="card">
                <h2 class="card-title">üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h2>
                
                <!-- Progress Bar -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-title">
                        <span class="spinner" style="width: 16px; height: 16px;"></span>
                        <span>–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...</span>
                    </div>
                    <div class="progress-steps">
                        <div class="progress-step" data-step="documents">
                            <div class="step-icon pending" id="step-documents">
                                <span class="step-status">üìÑ</span>
                            </div>
                            <span class="step-label">–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
                        </div>
                        <div class="progress-step" data-step="parsing">
                            <div class="step-icon pending" id="step-parsing">
                                <span class="step-status">üìù</span>
                            </div>
                            <span class="step-label">–ü–∞—Ä—Å–∏–Ω–≥</span>
                        </div>
                        <div class="progress-step" data-step="chunking">
                            <div class="step-icon pending" id="step-chunking">
                                <span class="step-status">‚úÇÔ∏è</span>
                            </div>
                            <span class="step-label">–ß–∞–Ω–∫–∏–Ω–≥</span>
                        </div>
                        <div class="progress-step" data-step="embedding">
                            <div class="step-icon pending" id="step-embedding">
                                <span class="step-status">üß†</span>
                            </div>
                            <span class="step-label">–≠–º–±–µ–¥–¥–∏–Ω–≥–∏</span>
                        </div>
                        <div class="progress-step" data-step="faiss">
                            <div class="step-icon pending" id="step-faiss">
                                <span class="step-status">üíæ</span>
                            </div>
                            <span class="step-label">FAISS</span>
                        </div>
                    </div>
                    
                    <!-- Percentage Bar -->
                    <div class="percent-bar-container">
                        <div class="percent-bar-header">
                            <span class="percent-bar-label">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                            <span class="percent-bar-value" id="percentValue">0%</span>
                        </div>
                        <div class="percent-bar">
                            <div class="percent-bar-fill" id="percentBarFill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="progress-message" id="progressMessage"></div>
                </div>
                
                <div class="dropzone" id="dropzone">
                    <div class="dropzone-icon">üìÑ</div>
                    <div class="dropzone-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
                    <div class="dropzone-formats">PDF, DOCX, TXT, MD, PY, JS, JSON –∏ –¥—Ä—É–≥–∏–µ</div>
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.docx,.txt,.md,.py,.js,.ts,.java,.cpp,.c,.go,.rs,.json,.yaml,.yml">
                
                <div class="file-list" id="fileList"></div>
                
                <div class="loading" id="uploadLoading">
                    <div class="spinner"></div>
                    <span>–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...</span>
                </div>
                
                <div class="actions">
                    <button class="btn btn-danger" id="clearBtn" onclick="clearIndex()">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏–Ω–¥–µ–∫—Å
                    </button>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="card">
                <h2 class="card-title">üí¨ –ü–æ–∏—Å–∫ –∏ –≤–æ–ø—Ä–æ—Å—ã</h2>
                
                <form class="search-form" onsubmit="askQuestion(event)">
                    <input type="text" class="search-input" id="queryInput" 
                           placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º..." required>
                    <button type="submit" class="btn btn-primary" id="askBtn">
                        üîç –°–ø—Ä–æ—Å–∏—Ç—å
                    </button>
                </form>
                
                <div class="loading" id="searchLoading">
                    <div class="spinner"></div>
                    <span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞... (–¥–æ 2 –º–∏–Ω—É—Ç)</span>
                </div>
                
                <div class="results" id="results"></div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadLoading = document.getElementById('uploadLoading');
        const searchLoading = document.getElementById('searchLoading');
        const results = document.getElementById('results');
        const toast = document.getElementById('toast');
        const progressContainer = document.getElementById('progressContainer');
        const progressMessage = document.getElementById('progressMessage');
        
        // SSE –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
        let progressEventSource = null;
        
        function connectProgressSSE() {
            if (progressEventSource) {
                progressEventSource.close();
            }
            
            progressEventSource = new EventSource('/api/progress');
            
            progressEventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateProgressUI(data);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ SSE:', e);
                }
            };
            
            progressEventSource.onerror = function(e) {
                console.log('SSE –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                setTimeout(connectProgressSSE, 3000);
            };
        }
        
        function updateProgressUI(data) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            if (data.active) {
                progressContainer.classList.add('active');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —ç—Ç–∞–ø–æ–≤
            const steps = ['documents', 'parsing', 'chunking', 'embedding', 'faiss'];
            const statusIcons = {
                pending: '‚è≥',
                processing: '‚è≥',
                completed: '‚úÖ',
                error: '‚ùå'
            };
            
            steps.forEach(step => {
                const stepData = data.steps[step];
                const stepElement = document.getElementById(`step-${step}`);
                
                if (stepElement && stepData) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å
                    stepElement.className = `step-icon ${stepData.status}`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Å—Ç–∞—Ç—É—Å–∞
                    const statusSpan = stepElement.querySelector('.step-status');
                    if (stepData.status === 'completed') {
                        statusSpan.textContent = '‚úÖ';
                    } else if (stepData.status === 'error') {
                        statusSpan.textContent = '‚ùå';
                    } else if (stepData.status === 'processing') {
                        // –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∏–∫–æ–Ω–∫—É —ç—Ç–∞–ø–∞
                        const icons = { documents: 'üìÑ', parsing: 'üìù', chunking: '‚úÇÔ∏è', embedding: 'üß†', faiss: 'üíæ' };
                        statusSpan.textContent = icons[step];
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç
            const percent = data.percent || 0;
            const percentValue = document.getElementById('percentValue');
            const percentBarFill = document.getElementById('percentBarFill');
            
            if (percentValue && percentBarFill) {
                percentValue.textContent = `${percent}%`;
                percentBarFill.style.width = `${percent}%`;
                
                if (percent >= 100) {
                    percentBarFill.classList.add('complete');
                } else {
                    percentBarFill.classList.remove('complete');
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (data.error) {
                progressMessage.textContent = data.error;
                progressMessage.classList.add('error');
            } else if (data.current_file) {
                progressMessage.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞: ${data.current_file} (${data.processed_files}/${data.total_files})`;
                progressMessage.classList.remove('error');
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç—Ç–∞–ø–∞
                for (const step of [...steps].reverse()) {
                    if (data.steps[step].message) {
                        progressMessage.textContent = data.steps[step].message;
                        progressMessage.classList.remove('error');
                        break;
                    }
                }
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            if (!data.active && !data.error) {
                const allCompleted = steps.every(s => data.steps[s].status === 'completed' || data.steps[s].status === 'pending');
                if (allCompleted && data.steps.faiss.status === 'completed') {
                    setTimeout(() => {
                        progressContainer.classList.remove('active');
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
                        steps.forEach(step => {
                            const stepElement = document.getElementById(`step-${step}`);
                            if (stepElement) {
                                stepElement.className = 'step-icon pending';
                                const icons = { documents: 'üìÑ', parsing: 'üìù', chunking: '‚úÇÔ∏è', embedding: 'üß†', faiss: 'üíæ' };
                                stepElement.querySelector('.step-status').textContent = icons[step];
                            }
                        });
                        progressMessage.textContent = '';
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π –±–∞—Ä
                        if (percentValue) percentValue.textContent = '0%';
                        if (percentBarFill) {
                            percentBarFill.style.width = '0%';
                            percentBarFill.classList.remove('complete');
                        }
                    }, 2000);
                }
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                document.getElementById('statVectors').textContent = data.total_vectors;
                document.getElementById('statDocs').textContent = data.total_documents;
                document.getElementById('statChunks').textContent = data.total_chunks;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', e);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.className = 'toast', 3000);
        }
        
        // Drag & Drop
        dropzone.addEventListener('click', () => fileInput.click());
        
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) uploadFiles(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) uploadFiles(e.target.files);
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
        async function uploadFiles(files) {
            fileList.innerHTML = '';
            uploadLoading.classList.add('active');
            progressContainer.classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã
            for (const file of files) {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span class="file-name">üìÑ ${file.name}</span>
                    <span class="file-status pending">‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...</span>
                `;
                fileList.appendChild(item);
            }
            
            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }
            
            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
                    const items = fileList.querySelectorAll('.file-item');
                    data.files.forEach((file, i) => {
                        if (items[i]) {
                            const status = items[i].querySelector('.file-status');
                            if (file.error) {
                                status.className = 'file-status error';
                                status.textContent = '‚ùå ' + file.error;
                            } else {
                                status.className = 'file-status success';
                                status.textContent = `‚úÖ ${file.chunks} —á–∞–Ω–∫–æ–≤`;
                            }
                        }
                    });
                    
                    showToast(`–ü—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ ${data.indexed_chunks} —á–∞–Ω–∫–æ–≤`, 'success');
                    loadStats();
                }
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, 'error');
            } finally {
                uploadLoading.classList.remove('active');
            }
        }
        
        // –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å
        async function askQuestion(e) {
            e.preventDefault();
            
            const query = document.getElementById('queryInput').value.trim();
            if (!query) return;
            
            searchLoading.classList.add('active');
            searchLoading.querySelector('span').textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞... (–¥–æ 2 –º–∏–Ω—É—Ç)';
            results.innerHTML = '';
            document.getElementById('askBtn').disabled = true;
            
            // –¢–∞–π–º–∞—É—Ç 3 –º–∏–Ω—É—Ç—ã
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 180000);
            
            try {
                const res = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, top_k: 3 }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const data = await res.json();
                
                if (data.error) {
                    results.innerHTML = `<div class="answer-box" style="border-color: var(--danger);">
                        <div class="answer-text">‚ùå ${data.error}</div>
                    </div>`;
                } else {
                    let sourcesHtml = '';
                    if (data.sources && data.sources.length) {
                        sourcesHtml = `<div class="sources">
                            <div class="sources-title">üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:</div>
                            ${data.sources.map(s => `<span class="source-item">üìÑ ${s.filename}</span>`).join('')}
                        </div>`;
                    }
                    
                    results.innerHTML = `<div class="answer-box">
                        <div class="answer-label">üí° –û—Ç–≤–µ—Ç:</div>
                        <div class="answer-text">${escapeHtml(data.answer)}</div>
                        ${sourcesHtml}
                    </div>`;
                }
            } catch (e) {
                clearTimeout(timeoutId);
                const errorMsg = e.name === 'AbortError' 
                    ? '–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞. LLM –Ω–µ —É—Å–ø–µ–ª–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å.' 
                    : e.message;
                results.innerHTML = `<div class="answer-box" style="border-color: var(--danger);">
                    <div class="answer-text">‚ùå –û—à–∏–±–∫–∞: ${errorMsg}</div>
                </div>`;
            } finally {
                searchLoading.classList.remove('active');
                searchLoading.querySelector('span').textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞... (–¥–æ 2 –º–∏–Ω—É—Ç)';
                document.getElementById('askBtn').disabled = false;
            }
        }
        
        // –û—á–∏—Å—Ç–∏—Ç—å –∏–Ω–¥–µ–∫—Å
        async function clearIndex() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∏–Ω–¥–µ–∫—Å –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
            
            try {
                const res = await fetch('/api/clear', { method: 'POST' });
                const data = await res.json();
                
                if (data.error) {
                    showToast(data.error, 'error');
                } else {
                    showToast('–ò–Ω–¥–µ–∫—Å –æ—á–∏—â–µ–Ω', 'success');
                    fileList.innerHTML = '';
                    results.innerHTML = '';
                    progressContainer.classList.remove('active');
                    loadStats();
                }
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }
        
        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadStats();
        connectProgressSSE();
    </script>
</body>
</html>
